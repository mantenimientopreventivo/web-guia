<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorar postes, riendas y varios - Guía</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos Generales y Fondo */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, Helvetica, sans-serif; font-size: 13px; }
        body { background-image: url('movistar.png'); background-size: contain; background-position: center; background-repeat: no-repeat; background-color: #0099e4; background-attachment: fixed; }
        .main-container { max-width: 900px; margin: 10px auto; padding: 15px; background-color: rgba(0, 0, 0, 0.8); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); color: white; }
        .back-button { display: inline-block; padding: 5px 12px; margin-bottom: 10px; background-color: #00A9E0; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; transition: background-color 0.3s; }
        .back-button:hover { background-color: #0078a8; }
        h1 { text-align: center; color: #00A9E0; margin: 0 0 15px; font-size: 1.6em; text-transform: uppercase; }
        .calculator-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .calculator-table th, .calculator-table td { border: 1px solid #777; padding: 5px; text-align: center; }
        .calculator-table th { background-color: #003755; }
        .calculator-table td.item-name { text-align: left; background-color: rgba(255,255,255,0.05); }
        .calculator-table input[type="number"], .calculator-table select { width: 90%; padding: 4px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; }
        .total-row { background-color: #333; font-weight: bold; font-size: 1.1em; }
        
        .clear-button-container { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; /* Espacio entre botones */
            margin-top: 10px; 
        }
        
        .clear-button { background-color: #6c757d; color: white; border: none; padding: 8px 15px; font-size: 0.9em; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .clear-button:hover { background-color: #5a6268; }

        /* Estilo nuevo botón PDF */
        .pdf-button { background-color: #dc3545; color: white; border: none; padding: 8px 15px; font-size: 0.9em; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .pdf-button:hover { background-color: #bb2d3b; }

    </style>
</head>
<body>
    <div class="main-container">
        <a href="index.html" class="back-button">‹ Volver al Índice</a>
        <h1>Valorar postes, riendas y varios</h1>
        <table class="calculator-table" id="tabla-datos">
            <thead>
                <tr>
                    <th>Grupo</th>
                    <th>Tarea</th>
                    <th style="width: 40%;">Denominacion</th>
                    <th>Baremo</th>
                    <th>Ingrese Cantidad</th>
                    <th>H.B</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>82</td>
                    <td>6</td>
                    <td class="item-name">Instalar riostra con tirante (rienda) <a href="82-6.jpg" target="_blank" style="color: #00A9E0; text-decoration: none; font-weight: bold;">+info</a></td>
                    <td id="baremo-1" data-baremo="7.5">7,5</td>
                    <td><input type="number" id="cantidad-1" oninput="calculateRow(1)"></td>
                    <td id="hb-1">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>10</td>
                    <td class="item-name">Instalar Poste de madera, concreto, PRFV, metal sin basamento</td>
                    <td id="baremo-2" data-baremo="7">7</td>
                    <td><input type="number" id="cantidad-2" oninput="calculateRow(2)"></td>
                    <td id="hb-2">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>103</td>
                    <td class="item-name">Aplomar o corregir emplazamiento de poste sin basamento <a href="82-103.jpg" target="_blank" style="color: #00A9E0; text-decoration: none; font-weight: bold;">+info</a></td>
                    <td id="baremo-3" data-baremo="2">2</td>
                    <td><input type="number" id="cantidad-3" oninput="calculateRow(3)"></td>
                    <td id="hb-3">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>110</td>
                    <td class="item-name">Colocar conjunto de peldaño y estribos en poste existente
                        <select id="option-4" onchange="updateOption(4)">
                            <option value="1.5">Postes con RED o solo APOYO: ½ estribado</option>
                            <option value="3">Postes con CTO o HUB: estribado completo</option>
                        </select>
                    </td>
                    <td id="baremo-4" data-baremo="1.5">1.5</td>
                    <td><input type="number" id="cantidad-4" oninput="calculateRow(4)"></td>
                    <td id="hb-4">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>204</td>
                    <td class="item-name">Desmontar poste sin basamento o sin eliminar basamento <a href="82-204.jpg" target="_blank" style="color: #00A9E0; text-decoration: none; font-weight: bold;">+info</a></td>
                    <td id="baremo-5" data-baremo="4.6">4,6</td>
                    <td><input type="number" id="cantidad-5" oninput="calculateRow(5)"></td>
                    <td id="hb-5">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>210</td>
                    <td class="item-name">Cambio de poste de línea o apoyo <a href="82-210.jpg" target="_blank" style="color: #00A9E0; text-decoration: none; font-weight: bold;">+info</a></td>
                    <td id="baremo-6" data-baremo="15">15</td>
                    <td><input type="number" id="cantidad-6" oninput="calculateRow(6)"></td>
                    <td id="hb-6">0.00</td>
                </tr>
                <tr>
                    <td>82</td>
                    <td>211</td>
                    <td class="item-name">Cambio de Poste Terminal</td>
                    <td id="baremo-7" data-baremo="21">21</td>
                    <td><input type="number" id="cantidad-7" oninput="calculateRow(7)"></td>
                    <td id="hb-7">0.00</td>
                </tr>
                <tr>
                    <td>84</td>
                    <td>232</td>
                    <td class="item-name">Desmontar Acometida</td>
                    <td id="baremo-8" data-baremo="0.20">0,20</td>
                    <td><input type="number" id="cantidad-8" oninput="calculateRow(8)"></td>
                    <td id="hb-8">0.00</td>
                </tr>
                <tr>
                    <td>84</td>
                    <td>360</td>
                    <td class="item-name">Tendido de cable telefónico en todo tipo de Infraestructura aérea o canalizada</td>
                    <td id="baremo-9" data-baremo="0.12">0,12</td>
                    <td><input type="number" id="cantidad-9" oninput="calculateRow(9)"></td>
                    <td id="hb-9">0.00</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row"><td colspan="5">TOTAL</td><td id="total-hb">0.00</td></tr>
            </tfoot>
        </table>
        
        <div class="clear-button-container">
            <button class="pdf-button" onclick="generatePDF()">
                <i class="fa-solid fa-file-pdf"></i> Generar PDF
            </button>
            <button class="clear-button" onclick="clearCalculator()">Limpiar</button>
        </div>
    </div>

    <script>
    function updateOption(rowNum) {
        const select = document.getElementById(`option-${rowNum}`);
        const value = parseFloat(select.value);
        const cell = document.getElementById(`baremo-${rowNum}`);
        cell.dataset.baremo = value;
        calculateRow(rowNum);
    }
    function calculateRow(rowNum) {
        const baremo = parseFloat(document.getElementById(`baremo-${rowNum}`).dataset.baremo);
        const cantidad = parseFloat(document.getElementById(`cantidad-${rowNum}`).value) || 0;
        const hb = cantidad * baremo;
        document.getElementById(`hb-${rowNum}`).innerText = hb.toFixed(2);
        updateTotal();
    }
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('[id^="hb-"]').forEach(cell => total += parseFloat(cell.innerText) || 0);
        document.getElementById('total-hb').innerText = total.toFixed(2);
    }
    function clearCalculator() {
        document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        document.querySelectorAll('[id^="hb-"]').forEach(cell => cell.innerText = '0.00');
        updateTotal();
    }

    // --- NUEVA FUNCIÓN PARA GENERAR PDF ---
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 1. Título del Documento
        doc.setFontSize(16);
        doc.setTextColor(0, 169, 224); // Azul Movistar/Telefonica
        doc.text("Reporte de Valoración - Postes y Riendas", 14, 20);
        
        doc.setFontSize(10);
        doc.setTextColor(100);
        const fecha = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString();
        doc.text("Fecha: " + fecha, 14, 28);

        // 2. Preparar los datos de la tabla
        let rows = [];
        let totalGeneral = document.getElementById('total-hb').innerText;

        // Recorremos las filas (hardcoded 9 filas en este ejemplo, o usar selector)
        // Usamos un selector dinámico para barrer todas las filas que tengan input
        const inputs = document.querySelectorAll('input[type="number"]');
        
        inputs.forEach((input, index) => {
            let cantidad = input.value;
            // IMPORTANTE: Solo agregamos al PDF si la cantidad es mayor a 0
            if (cantidad && parseFloat(cantidad) > 0) {
                let rowNum = index + 1; // Asumiendo orden secuencial
                
                // Obtener datos de la fila
                let tr = input.closest('tr');
                let tds = tr.querySelectorAll('td');
                
                let grupo = tds[0].innerText;
                let tarea = tds[1].innerText;
                
                // Lógica para obtener la descripción limpia (sin el texto +info)
                let descripcionCell = tds[2];
                let descripcion = "";
                
                // Si hay un select, tomamos el texto de la opción seleccionada
                let select = descripcionCell.querySelector('select');
                if (select) {
                     descripcion = select.options[select.selectedIndex].text;
                } else {
                    // Si no, tomamos el texto y quitamos el "+info" si existe
                    descripcion = descripcionCell.innerText.replace('+info', '').trim();
                }

                let baremo = document.getElementById(`baremo-${rowNum}`).innerText; // Ojo: puede variar si se actualizó
                let hb = document.getElementById(`hb-${rowNum}`).innerText;

                rows.push([grupo, tarea, descripcion, baremo, cantidad, hb]);
            }
        });

        // Si no hay tareas, avisar
        if (rows.length === 0) {
            alert("No hay tareas valoradas para generar el PDF.");
            return;
        }

        // Agregar fila de total al final
        rows.push(['', '', '', '', 'TOTAL', totalGeneral]);

        // 3. Generar la tabla en el PDF
        doc.autoTable({
            head: [['Grupo', 'Tarea', 'Denominación', 'Baremo', 'Cant.', 'H.B.']],
            body: rows,
            startY: 35,
            theme: 'grid',
            headStyles: { fillColor: [0, 55, 85] }, // Azul oscuro headers
            footStyles: { fillColor: [51, 51, 51] },
            columnStyles: {
                0: { cellWidth: 15 },
                1: { cellWidth: 15 },
                4: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 20, halign: 'right', fontStyle: 'bold' }
            },
            didParseCell: function (data) {
                // Negrita para la fila de TOTAL
                if (data.row.index === rows.length - 1) {
                    data.cell.styles.fontStyle = 'bold';
                    data.cell.styles.fillColor = [220, 220, 220];
                }
            }
        });

        // 4. Descargar
        doc.save('Reporte_Valoracion_Postes.pdf');
    }
    </script>
</body>
</html>