<script defer>
    // ... (todo el código JavaScript anterior, sin cambios hasta generateNextMonthCalendar) ...

    function generateNextMonthCalendar() {
        const today = new Date();
        console.log("DEBUG: Fecha actual (today):", today);

        const nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1); // Primer día del próximo mes
        console.log("DEBUG: nextMonthDate (primer día del próximo mes):", nextMonthDate);

        // Obtener el mes y año del mes que se va a generar (próximo mes)
        const monthToGenerateKey = `${nextMonthDate.getFullYear()}-${(nextMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;
        console.log("DEBUG: monthToGenerateKey (formato YYYY-MM del mes a generar):", monthToGenerateKey);

        // Contar cuántos meses futuros ya están en el calendario
        let futureMonthsCount = 0;
        const existingFutureMonths = new Set();
        
        // Recorrer todos los horarios de todos los empleados para encontrar meses futuros únicos
        presencialidadState.calendar.forEach(employee => {
            if (employee.schedule) {
                employee.schedule.forEach(dayInfo => {
                    const dayDate = new Date(dayInfo.date);
                    // Comparamos el mes y año de la fecha actual para ver si es futuro
                    // Si el año de la fecha del día es mayor O si es el mismo año pero el mes es mayor
                    if (dayDate.getFullYear() > today.getFullYear() || 
                       (dayDate.getFullYear() === today.getFullYear() && dayDate.getMonth() > today.getMonth())) {
                        existingFutureMonths.add(`${dayDate.getFullYear()}-${(dayDate.getMonth() + 1).toString().padStart(2, '0')}`);
                    }
                });
            }
        });
        futureMonthsCount = existingFutureMonths.size;
        console.log("DEBUG: Meses futuros existentes (existingFutureMonths):", Array.from(existingFutureMonths));
        console.log("DEBUG: futureMonthsCount:", futureMonthsCount);

        const isMonthAlreadyGenerated = existingFutureMonths.has(monthToGenerateKey);
        console.log("DEBUG: isMonthAlreadyGenerated (el mes a generar ya existe?):", isMonthAlreadyGenerated);


        if (futureMonthsCount >= 2 && !isMonthAlreadyGenerated) {
            alert("No se puede generar. Ya tienes un calendario generado para los próximos 2 meses. Primero debes avanzar en el tiempo o eliminar datos antiguos para generar más.");
            return;
        }
        
        // Si el mes a generar ya existe, no es necesario generar las fechas, solo asegurar que tienen el status 'Remoto'
        if (isMonthAlreadyGenerated) {
             alert(`El calendario para ${monthToGenerateKey} ya está generado. Se están verificando/actualizando los días a 'Remoto' si están vacíos.`);
             // No necesitamos recalcular lastDayOfNextMonth si solo estamos actualizando.
             // Simplemente recorremos el calendario existente para ese mes.
        } else {
             alert(`Generando calendario para ${monthToGenerateKey}.`);
        }

        // Calcular el número de días en el próximo mes
        const lastDayOfNextMonth = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth() + 1, 0).getDate();
        console.log("DEBUG: lastDayOfNextMonth:", lastDayOfNextMonth);


        presencialidadState.empleados.forEach(employeeName => {
            let employeeEntry = presencialidadState.calendar.find(e => e.name === employeeName);
            if (!employeeEntry) {
                employeeEntry = { name: employeeName, schedule: [] };
                presencialidadState.calendar.push(employeeEntry);
            }

            for (let day = 1; day <= lastDayOfNextMonth; day++) {
                const currentDate = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth(), day);
                // Solo agregar días de Lunes a Viernes
                if (currentDate.getDay() >= 1 && currentDate.getDay() <= 5) { // 1=Lunes, 5=Viernes
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    let existingDay = employeeEntry.schedule.find(s => s.date === dateString);
                    
                    if (existingDay) {
                        // Si ya existe, actualizamos a "Remoto" si no tiene un valor ya asignado
                        // Esto previene sobrescribir una asignación manual si se regenera
                        if (existingDay.status === "" || existingDay.status === "-") {
                            existingDay.status = "Remoto"; 
                        }
                    } else {
                        // Si no existe, añadir con "Remoto" por defecto
                        employeeEntry.schedule.push({ date: dateString, status: "Remoto" }); 
                    }
                }
            }
            employeeEntry.schedule.sort((a, b) => new Date(a.date) - new Date(b.date));
        });
        presencialidadState.calendar.sort((a,b) => a.name.localeCompare(b.name)); 
        renderAdminPanel(); // Se vuelve a renderizar para mostrar las nuevas fechas y estados
        alert("Calendario del próximo mes generado con días laborales en 'Remoto' por defecto.");
    }

    // ... (el resto del código JavaScript, sin cambios) ...
</script>
