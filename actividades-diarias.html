<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignador de Actividades Diarias - Guía</title>
    <style>
        /* Estilos Generales */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, Helvetica, sans-serif; }
        body {
            background-image: url('movistar.png'); /* Asegúrate de tener esta imagen en la misma carpeta */
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #0099e4;
            background-attachment: fixed;
        }
        .main-container {
            max-width: 1200px; margin: 20px auto; padding: 20px;
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            color: white;
        }
        .back-button {
            display: inline-block; padding: 6px 14px; margin-bottom: 15px;
            background-color: #00A9E0; color: white; text-decoration: none;
            border-radius: 8px; font-weight: bold; transition: background-color 0.3s;
        }
        .back-button:hover { background-color: #0078a8; }
        
        h1 { text-align: center; color: #00A9E0; text-transform: uppercase; font-size: 1.8em; margin-top: 0; }

        /* Panel de Acciones */
        .actions-panel { text-align: center; margin: 20px 0; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .action-button {
            background-color: #007bff; color: white; border: none;
            padding: 12px 25px; font-size: 1.1em; font-weight: bold;
            border-radius: 5px; cursor: pointer; transition: background-color 0.3s;
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }
        .action-button:hover { background-color: #0056b3; }
        .generate-btn { background-color: #28a745; }
        .generate-btn:hover { background-color: #218838; }
        .save-manual-btn { background-color: #ffc107; color: black;} /* Botón amarillo */
        .save-manual-btn:hover { background-color: #e0a800; }
        .clear-history-btn, .lock-controls-btn { background-color: #dc3545; } /* Rojo para borrar o bloquear */
        .clear-history-btn:hover, .lock-controls-btn:hover { background-color: #c82333; }


        /* Tabla Principal de Asignación */
        .assignment-table {
            width: 100%; border-collapse: collapse; background-color: white;
            color: black; border-radius: 8px; overflow: hidden; font-size: 0.9em;
        }
        .assignment-table th, .assignment-table td { border: 1px solid #000; padding: 10px; text-align: center; }
        .assignment-table thead { background-color: #e2e3e5; }
        .assignment-table .employee-name { text-align: left; font-weight: bold; }
        .assignment-table td[contenteditable="true"]:focus {
            background-color: #ffeeba; /* Color al editar */
            outline: none;
        }
        
        /* Colores por fila (se mantienen y se gestionan desde JS) */
        .row-ines { background-color: #cce5ff; } /* Azul claro */
        .row-nicolas { background-color: #d4edda; } /* Verde claro */
        .row-gabriela { background-color: #cce5ff; } /* Azul claro */
        .row-dante { background-color: #f8d7da; } /* Rosa/Rojo claro */

        /* Estilos para la Ventana Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 1100px;
            border-radius: 10px; color: black;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        
        #profile-matrix-table { width: 100%; }
        #profile-matrix-table input[type="checkbox"] { transform: scale(1.4); }

        /* Estilos para gestión de empleados/tareas en la modal */
        .management-section {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;
        }
        .management-section h3 { color: #007bff; margin-bottom: 15px; }
        .management-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px dotted #eee;
        }
        .management-item:last-child { border-bottom: none; }
        .management-item input[type="text"] {
            flex-grow: 1; padding: 5px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        .management-item-actions button {
            background-color: #dc3545; color: white; border: none;
            padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;
        }
        .management-item-actions button.edit-btn { background-color: #007bff; }
        .management-item-actions button:hover { opacity: 0.8; }
        .add-input-group { display: flex; margin-top: 10px; }
        .add-input-group input { flex-grow: 1; margin-right: 10px; }
        .add-input-group button { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .add-input-group button:hover { opacity: 0.9; }

        /* Estilos para la modal de historial */
        .history-entry {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .history-entry h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }
        .history-table {
            width: 100%; border-collapse: collapse; background-color: white;
            color: black; border-radius: 8px; overflow: hidden; font-size: 0.9em;
        }
        .history-table th, .history-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .history-table thead { background-color: #e9ecef; }
        .history-table .employee-name { text-align: left; font-weight: bold; }

    </style>
</head>
<body>
    <div class="main-container">
        <a href="index.html" class="back-button">‹ Volver al Índice</a>
        <h1>Asignación de Actividades Semanales</h1>

        <!-- Panel de Login (Visible por defecto) -->
        <div id="login-panel" class="actions-panel">
            <button class="action-button" onclick="promptForAdmin()">Modo Administrador</button>
        </div>

        <!-- Controles de Admin (Ocultos por defecto) -->
        <div id="admin-controls" class="actions-panel" style="display: none;">
            <button class="action-button generate-btn" onclick="generarNuevaAsignacion()">Generar Nueva Asignación</button>
            <button class="action-button save-manual-btn" onclick="saveManualAssignment()">Guardar Asignación Manual</button>
            <button class="action-button" onclick="openProfileEditor()">Editar Perfiles y Gestión</button>
            <button class="action-button" onclick="openHistoryModal()">Ver Historial</button>
            <button class="action-button lock-controls-btn" onclick="lockAdminControls()">Bloquear Controles</button>
        </div>

        <table class="assignment-table">
            <thead>
                <tr>
                    <th>Empleado</th>
                    <th>Tarea 1</th>
                    <th>Tarea 2</th>
                    <th>Tarea 3</th>
                    <th>Tarea 4</th>
                </tr>
            </thead>
            <tbody id="asignacion-tbody">
                <!-- Las filas de asignación se generarán aquí -->
            </tbody>
        </table>
    </div>

    <!-- VENTANA MODAL PARA EDITAR PERFILES Y GESTIÓN -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeProfileEditor()">×</span>
            <h2>Editar Habilidades y Gestión</h2>
            
            <!-- Sección de Edición de Perfiles -->
            <h3>Habilidades por Empleado</h3>
            <div style="max-height: 40vh; overflow: auto; border: 1px solid #eee; border-radius: 5px;">
                <table class="assignment-table" id="profile-matrix-table">
                    <!-- La matriz de checkboxes se generará aquí -->
                </table>
            </div>
            <div class="actions-panel" style="margin-top: 15px; padding-bottom: 0;">
                <button class="action-button" onclick="guardarPerfiles()">Guardar Perfiles de Habilidades</button>
            </div>

            <!-- Sección de Gestión de Empleados -->
            <div class="management-section">
                <h3>Gestión de Empleados</h3>
                <div id="employee-list">
                    <!-- Lista de empleados se generará aquí -->
                </div>
                <div class="add-input-group">
                    <input type="text" id="new-employee-name" placeholder="Nuevo empleado">
                    <button onclick="addEmployee()">Agregar Empleado</button>
                </div>
            </div>

            <!-- Sección de Gestión de Tareas -->
            <div class="management-section">
                <h3>Gestión de Tareas</h3>
                <div id="task-list">
                    <!-- Lista de tareas se generará aquí -->
                </div>
                <div class="add-input-group">
                    <input type="text" id="new-task-name" placeholder="Nueva tarea">
                    <button onclick="addTask()">Agregar Tarea</button>
                </div>
            </div>

            <div class="actions-panel" style="margin-top: 30px;">
                <button class="action-button" onclick="closeProfileEditor()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- VENTANA MODAL PARA HISTORIAL -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeHistoryModal()">×</span>
            <h2>Historial de Asignaciones Semanales</h2>
            <div id="history-content" style="max-height: 70vh; overflow: auto;">
                <!-- El historial se generará aquí -->
            </div>
            <div class="actions-panel" style="justify-content: space-between;">
                <button class="action-button clear-history-btn" onclick="clearHistory()">Borrar Historial Completo</button>
                <button class="action-button" onclick="closeHistoryModal()">Cerrar</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURACIÓN INICIAL DE DATOS (AHORA SE CARGAN DINÁMICAMENTE) ---
        let TAREAS = [];
        let EMPLEADOS = [];
        let COLORES_FILA = {}; // Se gestionará dinámicamente

        const MAX_TAREAS_POR_EMPLEADO = 4;
        const HISTORY_LIMIT = 2; // Limite de asignaciones en el historial

        // Valores por defecto si no hay nada en localStorage
        const DEFAULT_TAREAS = [
            "atencion de mails y derivacion segun el caso", "carga de planos y datos de red a desmontes",
            "crear sigest de desmontes", "gestion de saneamientos", "planes de estabilidad",
            "postes pendientes de valorar", "seguimiento de desvios", "segurizaciones CR (sigest y valorar)",
            "sigest y valoracion de camaras rotas", "valorar desmontes con momento cero",
            "valorar sigest de emergencias", "vistos buenos", "verificar sigest devueltos"
        ];
        const DEFAULT_EMPLEADOS = ["ines raposo", "nicolas ponce", "gabriela torres", "dante espejo"];
        const DEFAULT_COLORES_FILA = {
            "ines raposo": "row-ines",
            "nicolas ponce": "row-nicolas",
            "gabriela torres": "row-ines", // Reutiliza el azul según la imagen
            "dante espejo": "row-dante"
        };
        const DEFAULT_PERFILES = {
            "ines raposo": ["seguimiento de desvios", "postes pendientes de valorar", "vistos buenos"],
            "nicolas ponce": ["crear sigest de desmontes", "valorar desmontes con momento cero", "valorar sigest de emergencias", "verificar sigest devueltos"],
            "gabriela torres": ["atencion de mails y derivacion segun el caso", "segurizaciones CR (sigest y valorar)", "sigest y valoracion de camaras rotas"],
            "dante espejo": ["carga de planos y datos de red a desmontes", "gestion de saneamientos", "seguimiento de desvios", "planes de estabilidad"]
        };


        // Carga los datos iniciales o por defecto
        function _loadInitialData() {
            TAREAS = JSON.parse(localStorage.getItem('tareasDisponibles')) || DEFAULT_TAREAS;
            EMPLEADOS = JSON.parse(localStorage.getItem('empleados')) || DEFAULT_EMPLEADOS;
            COLORES_FILA = JSON.parse(localStorage.getItem('coloresFila')) || DEFAULT_COLORES_FILA;
        }

        // Guarda todos los datos en localStorage
        function _saveAllData() {
            localStorage.setItem('tareasDisponibles', JSON.stringify(TAREAS));
            localStorage.setItem('empleados', JSON.stringify(EMPLEADOS));
            localStorage.setItem('coloresFila', JSON.stringify(COLORES_FILA));
            // Perfiles y asignación actual se guardan en sus funciones específicas
        }

        // --- FUNCIONES DE ADMINISTRACIÓN ---
        function promptForAdmin() {
            const password = prompt("Por favor, ingrese la clave de administrador:", "");
            if (password === null) return; // Si el usuario cancela
            
            if (password === "1598") { // Aquí está la clave
                document.getElementById('admin-controls').style.display = 'flex';
                document.getElementById('login-panel').style.display = 'none';
            } else {
                alert("Clave incorrecta.");
            }
        }

        function lockAdminControls() {
            document.getElementById('admin-controls').style.display = 'none';
            document.getElementById('login-panel').style.display = 'flex';
        }


        function getPerfiles() {
            const perfilesGuardados = localStorage.getItem('perfilesEmpleadosTareas');
            if (perfilesGuardados) return JSON.parse(perfilesGuardados);
            return DEFAULT_PERFILES; // Devuelve los perfiles por defecto si no hay guardados
        }
        function savePerfiles(perfiles) { localStorage.setItem('perfilesEmpleadosTareas', JSON.stringify(perfiles)); }
        
        function getAsignacionActual() { return JSON.parse(localStorage.getItem('asignacionSemanalActual')) || {}; }
        function saveAsignacionActual(asignacion) { localStorage.setItem('asignacionSemanalActual', JSON.stringify(asignacion)); }

        function getLastAssignmentDate() { return localStorage.getItem('lastAssignmentDate'); }
        function setLastAssignmentDate(date) { localStorage.setItem('lastAssignmentDate', date); }

        function getHistory() { return JSON.parse(localStorage.getItem('asignacionHistory')) || []; }
        function saveHistory(history) { localStorage.setItem('asignacionHistory', JSON.stringify(history)); }

        // --- LÓGICA DE ASIGNACIÓN AUTOMÁTICA ---

        function checkAndGenerateWeeklyAssignment() {
            const today = new Date();
            const lastAssignmentDateStr = getLastAssignmentDate();
            let lastAssignmentDate = null;
            if (lastAssignmentDateStr) {
                lastAssignmentDate = new Date(lastAssignmentDateStr);
            }

            const isMonday = today.getDay() === 1; // 1 = Lunes
            let shouldGenerate = false;

            if (isMonday) {
                if (!lastAssignmentDate) { // Nunca se ha generado
                    shouldGenerate = true;
                } else {
                    // Comprobar si la última asignación fue en un lunes diferente al actual
                    // Obtenemos el inicio de la semana (Lunes) para ambas fechas
                    const startOfCurrentWeek = new Date(today);
                    startOfCurrentWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); // Ajusta al Lunes

                    const startOfLastAssignmentWeek = new Date(lastAssignmentDate);
                    startOfLastAssignmentWeek.setDate(lastAssignmentDate.getDate() - (lastAssignmentDate.getDay() === 0 ? 6 : lastAssignmentDate.getDay() - 1)); // Ajusta al Lunes

                    // Si el inicio de la semana actual es diferente al de la última asignación
                    if (startOfCurrentWeek.toDateString() !== startOfLastAssignmentWeek.toDateString()) {
                         shouldGenerate = true;
                    }
                }
            }

            if (shouldGenerate) {
                if (confirm("¡Es lunes! ¿Deseas generar la asignación semanal automática?")) {
                    generarNuevaAsignacion(true); // Pasar true para indicar que es automática
                } else {
                    // Si el usuario cancela, registrar la fecha actual para no volver a preguntar hoy
                    setLastAssignmentDate(today.toISOString().split('T')[0]); 
                }
            }
        }

        // --- LÓGICA DE ASIGNACIÓN MANUAL Y AUTOMÁTICA (CON RONDAS PARA EQUILIBRAR) ---
        function generarNuevaAsignacion(isAutomatic = false) {
            if (!isAutomatic && !confirm("¿Generar una nueva asignación? La asignación actual se moverá al historial.")) {
                return;
            }
            
            const perfiles = getPerfiles();
            const asignacionAnterior = getAsignacionActual();
            const nuevaAsignacion = {};

            // Guardar la asignación actual en el historial
            let history = getHistory();
            if (Object.keys(asignacionAnterior).length > 0) {
                history.unshift({
                    date: new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
                    assignment: asignacionAnterior
                });
                if (history.length > HISTORY_LIMIT) {
                    history.pop();
                }
                saveHistory(history);
            }

            const globalAvailableTasks = [...TAREAS];
            EMPLEADOS.forEach(empleado => nuevaAsignacion[empleado] = []);

            const employeeTaskPools = {};
            
            // Pre-calcular los pools de tareas de alta y baja prioridad para cada empleado
            EMPLEADOS.forEach(empleado => {
                const tareasPosibles = perfiles[empleado] || [];
                const tareasAnteriores = asignacionAnterior[empleado] || [];
                
                employeeTaskPools[empleado] = {
                    high: tareasPosibles.filter(t => !tareasAnteriores.includes(t)),
                    low: tareasPosibles.filter(t => tareasAnteriores.includes(t))
                };
            });

            // Asignación por rondas para equilibrar
            for (let i = 0; i < MAX_TAREAS_POR_EMPLEADO; i++) {
                // Mezclar empleados en cada ronda para una distribución más justa
                const shuffledEmployees = [...EMPLEADOS].sort(() => Math.random() - 0.5);

                for (const empleado of shuffledEmployees) {
                    if (nuevaAsignacion[empleado].length < MAX_TAREAS_POR_EMPLEADO) {
                        let assignedTask = null;

                        // 1. Intentar asignar desde el pool de ALTA prioridad
                        let highPriorityCandidates = employeeTaskPools[empleado].high.filter(t => globalAvailableTasks.includes(t));
                        if (highPriorityCandidates.length > 0) {
                            const taskIndex = Math.floor(Math.random() * highPriorityCandidates.length);
                            assignedTask = highPriorityCandidates[taskIndex];
                        }

                        // 2. Si no se pudo, intentar asignar desde el pool de BAJA prioridad
                        if (!assignedTask) {
                            let lowPriorityCandidates = employeeTaskPools[empleado].low.filter(t => globalAvailableTasks.includes(t));
                            if (lowPriorityCandidates.length > 0) {
                                const taskIndex = Math.floor(Math.random() * lowPriorityCandidates.length);
                                assignedTask = lowPriorityCandidates[taskIndex];
                            }
                        }
                        
                        // Si se encontró una tarea para asignar
                        if (assignedTask) {
                            nuevaAsignacion[empleado].push(assignedTask);
                            
                            // Eliminarla del pool global
                            const globalIndex = globalAvailableTasks.indexOf(assignedTask);
                            if (globalIndex > -1) {
                                globalAvailableTasks.splice(globalIndex, 1);
                            }
                        }
                    }
                }
            }

            saveAsignacionActual(nuevaAsignacion);
            setLastAssignmentDate(new Date().toISOString().split('T')[0]);
            renderAsignacion();
            
            if (!isAutomatic) {
                alert("Nueva asignación semanal generada y equilibrada.");
            } else {
                alert("Asignación semanal automática generada y equilibrada.");
            }
        }

        function saveManualAssignment() {
            const currentAssignment = {};
            const tbody = document.getElementById('asignacion-tbody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const employeeName = row.querySelector('.employee-name').textContent.trim().toLowerCase();
                const tasks = [];
                // Se itera desde el segundo td (índice 1) para omitir el nombre del empleado
                for (let i = 1; i <= MAX_TAREAS_POR_EMPLEADO; i++) {
                    const taskCell = row.cells[i];
                    const taskText = taskCell.textContent.trim(); // No convertir a minúsculas para preservar mayúsculas/minúsculas introducidas
                    
                    // Aceptar cualquier texto, solo si no está vacío
                    if (taskText) {
                        tasks.push(taskText);
                    }
                }
                currentAssignment[employeeName] = tasks;
            });

            saveAsignacionActual(currentAssignment);
            renderAsignacion(); // Re-renderizar para reflejar los cambios guardados
            alert("Asignación manual guardada.");
        }


        // --- FUNCIONES DE VISUALIZACIÓN ---
        function renderAsignacion() {
            _loadInitialData(); // Cargar datos más recientes antes de renderizar
            const asignacion = getAsignacionActual();
            const tbody = document.getElementById('asignacion-tbody');
            tbody.innerHTML = '';

            EMPLEADOS.forEach(empleado => {
                const tareasAsignadas = asignacion[empleado] || [];
                const colorClass = COLORES_FILA[empleado] || '';
                let rowHtml = `<tr class="${colorClass}"><td class="employee-name">${empleado}</td>`;
                for (let i = 0; i < MAX_TAREAS_POR_EMPLEADO; i++) {
                    // Hacer las celdas de tareas editables
                    rowHtml += `<td contenteditable="true">${tareasAsignadas[i] || ''}</td>`;
                }
                rowHtml += `</tr>`;
                tbody.innerHTML += rowHtml;
            });
        }

        // --- FUNCIONES DEL EDITOR DE PERFILES Y GESTIÓN ---
        function openProfileEditor() {
            renderProfileMatrix();
            renderEmployeeManagement();
            renderTaskManagement();
            document.getElementById('profileModal').style.display = 'block';
        }
        function closeProfileEditor() {
            document.getElementById('profileModal').style.display = 'none';
            renderAsignacion(); // Re-renderizar la tabla principal por si se eliminó algo
        }

        function renderProfileMatrix() {
            _loadInitialData(); // Asegurarse de tener las últimas listas
            const perfiles = getPerfiles();
            const modalTable = document.getElementById('profile-matrix-table');
            let headerHtml = '<thead><tr><th>Tarea</th>';
            EMPLEADOS.forEach(e => headerHtml += `<th>${e}</th>`);
            headerHtml += '</tr></thead>';

            let bodyHtml = '<tbody>';
            TAREAS.forEach(tarea => {
                bodyHtml += `<tr><td class="employee-name">${tarea}</td>`;
                EMPLEADOS.forEach(empleado => {
                    const puedeHacerla = perfiles[empleado] && perfiles[empleado].includes(tarea);
                    bodyHtml += `<td><input type="checkbox" data-empleado="${empleado}" data-tarea="${tarea}" ${puedeHacerla ? 'checked' : ''}></td>`;
                });
                bodyHtml += `</tr>`;
            });
            bodyHtml += '</tbody>';
            modalTable.innerHTML = headerHtml + bodyHtml;
        }

        function guardarPerfiles() {
            const nuevosPerfiles = {};
            EMPLEADOS.forEach(e => nuevosPerfiles[e] = []);

            const checkboxes = document.querySelectorAll('#profile-matrix-table input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    nuevosPerfiles[cb.dataset.empleado].push(cb.dataset.tarea);
                }
            });
            
            savePerfiles(nuevosPerfiles);
            alert("Perfiles de habilidades guardados.");
            // No se cierra la modal aquí, el usuario puede seguir gestionando
        }

        // Gestión de Empleados
        function renderEmployeeManagement() {
            _loadInitialData(); // Asegurarse de tener la lista de empleados más reciente
            const employeeListDiv = document.getElementById('employee-list');
            employeeListDiv.innerHTML = '';

            EMPLEADOS.forEach(empleado => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'management-item';
                itemDiv.innerHTML = `
                    <input type="text" value="${empleado}" data-old-name="${empleado}">
                    <div class="management-item-actions">
                        <button class="edit-btn" onclick="saveEditedEmployee(this)">Guardar</button>
                        <button class="delete-btn" onclick="deleteEmployee('${empleado}')">Eliminar</button>
                    </div>
                `;
                employeeListDiv.appendChild(itemDiv);
            });
        }

        function addEmployee() {
            const newEmployeeNameInput = document.getElementById('new-employee-name');
            let newName = newEmployeeNameInput.value.trim().toLowerCase();
            if (!newName) {
                alert("El nombre del empleado no puede estar vacío.");
                return;
            }
            if (EMPLEADOS.includes(newName)) {
                alert("Este empleado ya existe.");
                return;
            }

            EMPLEADOS.push(newName);
            COLORES_FILA[newName] = `row-${newName.replace(/\s+/g, '-') || 'default'}`; // Genera una clase de color única, 'default' por si hay nombres vacíos o solo espacios
            let perfiles = getPerfiles();
            perfiles[newName] = []; // Nuevo empleado sin tareas asignadas por defecto
            savePerfiles(perfiles);
            _saveAllData(); // Guarda las listas actualizadas
            renderEmployeeManagement();
            renderProfileMatrix(); // Actualiza la matriz de perfiles con el nuevo empleado
            newEmployeeNameInput.value = '';
            alert(`Empleado "${newName}" agregado.`);
        }

        function saveEditedEmployee(buttonElement) {
            const input = buttonElement.parentNode.previousElementSibling;
            const oldName = input.dataset.oldName;
            let newName = input.value.trim().toLowerCase();

            if (!newName) {
                alert("El nombre del empleado no puede estar vacío.");
                input.value = oldName; // Revertir a nombre antiguo
                return;
            }
            if (newName === oldName) {
                alert("El nombre no ha cambiado.");
                return;
            }
            if (EMPLEADOS.includes(newName)) {
                alert(`El empleado "${newName}" ya existe.`);
                input.value = oldName; // Revertir a nombre antiguo
                return;
            }

            const index = EMPLEADOS.indexOf(oldName);
            if (index > -1) {
                EMPLEADOS[index] = newName;

                // Actualizar perfiles
                let perfiles = getPerfiles();
                if (perfiles[oldName]) {
                    perfiles[newName] = perfiles[oldName];
                    delete perfiles[oldName];
                }
                savePerfiles(perfiles);

                // Actualizar colores de fila
                if (COLORES_FILA[oldName]) {
                    COLORES_FILA[newName] = COLORES_FILA[oldName];
                    delete COLORES_FILA[oldName];
                }

                // Actualizar asignación actual si el empleado estaba en ella
                let asignacion = getAsignacionActual();
                if (asignacion[oldName]) {
                    asignacion[newName] = asignacion[oldName];
                    delete asignacion[oldName];
                    saveAsignacionActual(asignacion);
                }

                // Actualizar historial
                let history = getHistory();
                history.forEach(entry => {
                    if (entry.assignment[oldName]) {
                        entry.assignment[newName] = entry.assignment[oldName];
                        delete entry.assignment[oldName];
                    }
                });
                saveHistory(history);

                _saveAllData(); // Guarda todas las listas y objetos actualizados
                renderEmployeeManagement();
                renderProfileMatrix(); // Re-renderizar para reflejar el cambio de nombre
                alert(`Empleado "${oldName}" renombrado a "${newName}".`);
            }
        }

        function deleteEmployee(employeeName) {
            if (!confirm(`¿Estás seguro de que quieres eliminar a "${employeeName}"? Esto eliminará todos sus datos de perfiles y asignaciones.`)) {
                return;
            }

            EMPLEADOS = EMPLEADOS.filter(e => e !== employeeName);

            // Eliminar de perfiles
            let perfiles = getPerfiles();
            delete perfiles[employeeName];
            savePerfiles(perfiles);

            // Eliminar de colores de fila
            delete COLORES_FILA[employeeName];

            // Eliminar de asignación actual
            let asignacion = getAsignacionActual();
            delete asignacion[employeeName];
            saveAsignacionActual(asignacion);

            // Eliminar del historial
            let history = getHistory();
            history.forEach(entry => {
                delete entry.assignment[employeeName];
            });
            saveHistory(history);

            _saveAllData(); // Guarda todas las listas y objetos actualizados
            renderEmployeeManagement();
            renderProfileMatrix(); // Re-renderizar para reflejar el cambio
            alert(`Empleado "${employeeName}" eliminado.`);
        }

        // Gestión de Tareas
        function renderTaskManagement() {
            _loadInitialData(); // Asegurarse de tener la lista de tareas más reciente
            const taskListDiv = document.getElementById('task-list');
            taskListDiv.innerHTML = '';

            TAREAS.forEach(tarea => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'management-item';
                itemDiv.innerHTML = `
                    <input type="text" value="${tarea}" data-old-name="${tarea}">
                    <div class="management-item-actions">
                        <button class="edit-btn" onclick="saveEditedTask(this)">Guardar</button>
                        <button class="delete-btn" onclick="deleteTask('${tarea}')">Eliminar</button>
                    </div>
                `;
                taskListDiv.appendChild(itemDiv);
            });
        }

        function addTask() {
            const newTaskNameInput = document.getElementById('new-task-name');
            let newName = newTaskNameInput.value.trim().toLowerCase();
            if (!newName) {
                alert("El nombre de la tarea no puede estar vacío.");
                return;
            }
            if (TAREAS.includes(newName)) {
                alert("Esta tarea ya existe.");
                return;
            }

            TAREAS.push(newName);
            _saveAllData(); // Guarda la lista de tareas actualizada
            renderTaskManagement();
            renderProfileMatrix(); // Actualiza la matriz de perfiles con la nueva tarea
            newTaskNameInput.value = '';
            alert(`Tarea "${newName}" agregada.`);
        }

        function saveEditedTask(buttonElement) {
            const input = buttonElement.parentNode.previousElementSibling;
            const oldName = input.dataset.oldName;
            let newName = input.value.trim().toLowerCase();

            if (!newName) {
                alert("El nombre de la tarea no puede estar vacío.");
                input.value = oldName;
                return;
            }
            if (newName === oldName) {
                alert("El nombre de la tarea no ha cambiado.");
                return;
            }
            if (TAREAS.includes(newName)) {
                alert(`La tarea "${newName}" ya existe.`);
                input.value = oldName;
                return;
            }

            const index = TAREAS.indexOf(oldName);
            if (index > -1) {
                TAREAS[index] = newName;

                // Actualizar perfiles: buscar y reemplazar la tarea en todos los perfiles
                let perfiles = getPerfiles();
                for (const empleado in perfiles) {
                    const taskIndex = perfiles[empleado].indexOf(oldName);
                    if (taskIndex > -1) {
                        perfiles[empleado][taskIndex] = newName;
                    }
                }
                savePerfiles(perfiles);

                // Actualizar asignación actual si la tarea estaba en ella
                let asignacion = getAsignacionActual();
                for (const empleado in asignacion) {
                    const taskIndex = asignacion[empleado].indexOf(oldName);
                    if (taskIndex > -1) {
                        asignacion[empleado][taskIndex] = newName;
                    }
                }
                saveAsignacionActual(asignacion);
                
                // Actualizar historial
                let history = getHistory();
                history.forEach(entry => {
                    for (const empleado in entry.assignment) {
                        const taskIndex = entry.assignment[empleado].indexOf(oldName);
                        if (taskIndex > -1) {
                            entry.assignment[empleado][taskIndex] = newName;
                        }
                    }
                });
                saveHistory(history);


                _saveAllData(); // Guarda todas las listas y objetos actualizados
                renderTaskManagement();
                renderProfileMatrix(); // Re-renderizar para reflejar el cambio de nombre
                alert(`Tarea "${oldName}" renombrada a "${newName}".`);
            }
        }

        function deleteTask(taskName) {
            if (!confirm(`¿Estás seguro de que quieres eliminar la tarea "${taskName}"? Esto la eliminará de todas las habilidades de empleados y asignaciones.`)) {
                return;
            }

            TAREAS = TAREAS.filter(t => t !== taskName);

            // Eliminar de perfiles: filtrar la tarea de todos los perfiles de empleados
            let perfiles = getPerfiles();
            for (const empleado in perfiles) {
                perfiles[empleado] = perfiles[empleado].filter(t => t !== taskName);
            }
            savePerfiles(perfiles);

            // Eliminar de asignación actual
            let asignacion = getAsignacionActual();
            for (const empleado in asignacion) {
                asignacion[empleado] = asignacion[empleado].filter(t => t !== taskName);
            }
            saveAsignacionActual(asignacion);

            // Eliminar del historial
            let history = getHistory();
            history.forEach(entry => {
                for (const empleado in entry.assignment) {
                    entry.assignment[empleado] = entry.assignment[empleado].filter(t => t !== taskName);
                }
            });
            saveHistory(history);

            _saveAllData(); // Guarda todas las listas y objetos actualizados
            renderTaskManagement();
            renderProfileMatrix(); // Re-renderizar para reflejar el cambio
            alert(`Tarea "${taskName}" eliminado.`);
        }

        // --- FUNCIONES DEL HISTORIAL ---
        function openHistoryModal() {
            renderHistory();
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function renderHistory() {
            const historyContentDiv = document.getElementById('history-content');
            historyContentDiv.innerHTML = '';
            const history = getHistory();

            if (history.length === 0) {
                historyContentDiv.innerHTML = '<p>No hay historial de asignaciones disponible.</p>';
                return;
            }

            history.forEach((entry, index) => {
                const historyEntryDiv = document.createElement('div');
                historyEntryDiv.className = 'history-entry';
                historyEntryDiv.innerHTML = `<h3>Asignación del ${entry.date} (Historial ${index + 1})</h3>`;

                const historyTable = document.createElement('table');
                historyTable.className = 'history-table';
                historyTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Tarea 1</th>
                            <th>Tarea 2</th>
                            <th>Tarea 3</th>
                            <th>Tarea 4</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = historyTable.querySelector('tbody');

                EMPLEADOS.forEach(empleado => {
                    const tareasAsignadas = entry.assignment[empleado] || [];
                    const colorClass = COLORES_FILA[empleado] || '';
                    let rowHtml = `<tr class="${colorClass}"><td class="employee-name">${empleado}</td>`;
                    for (let i = 0; i < MAX_TAREAS_POR_EMPLEADO; i++) {
                        rowHtml += `<td>${tareasAsignadas[i] || ''}</td>`;
                    }
                    rowHtml += `</tr>`;
                    tbody.innerHTML += rowHtml;
                });
                historyEntryDiv.appendChild(historyTable);
                historyContentDiv.appendChild(historyEntryDiv);
            });
        }

        function clearHistory() {
            if (confirm("¿Estás seguro de que quieres borrar todo el historial de asignaciones? Esta acción es irreversible.")) {
                saveHistory([]); // Vaciar el historial
                renderHistory(); // Actualizar la vista del historial (mostrará "No hay historial...")
                alert("Historial de asignaciones borrado.");
            }
        }


        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            _loadInitialData(); // Asegurarse de que las constantes globales estén cargadas
            renderAsignacion();
            checkAndGenerateWeeklyAssignment(); // Ejecutar la verificación al cargar
        });
    </script>
</body>
</html>