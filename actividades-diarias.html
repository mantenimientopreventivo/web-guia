<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Actividades</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, Helvetica, sans-serif; }
        body { background-color: #f4f4f4; }
        .admin-login-btn { position: fixed; top: 15px; right: 15px; z-index: 1001; padding: 8px 16px; background-color: #ffc107; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background-color 0.3s; }
        .admin-login-btn:hover { background-color: #e0a800; }
        .main-container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #333; }
        .assignment-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        .assignment-table th, .assignment-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .assignment-table thead { background-color: #00A9E0; color: white; }
        .assignment-table .employee-name { text-align: left; font-weight: bold; }
        #admin-view .assignment-table td[contenteditable="true"] { background-color: #fdfde2; cursor: text; }
        #admin-view .assignment-table td[contenteditable="true"]:focus { background-color: #fff2ab; outline: 2px solid #00A9E0; }
        .actions-panel { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
        .action-button { background-color: #007bff; color: white; border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .action-button:hover { opacity: 0.9; }
        .generate-btn { background-color: #28a745; }
        .clear-btn, .lock-btn { background-color: #dc3545; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1100px; border-radius: 10px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #profile-matrix-table input[type="checkbox"] { transform: scale(1.4); }
        .management-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .management-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dotted #eee; }
        .management-item span { flex-grow: 1; }
        .add-input-group { display: flex; margin-top: 10px; }
        .add-input-group input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .add-input-group button { margin-left: 10px; }
        #export-section { margin-top: 40px; padding: 20px; background-color: #eafaf1; border: 2px dashed #2ecc71; border-radius: 8px; text-align: center; }
        #export-section .download-button { background-color: #2ecc71; font-size: 1.2em; padding: 15px 30px; }
        .week-header { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <button id="login-button" class="admin-login-btn" onclick="promptForAdmin()">Modo Administrador</button>

    <div id="public-view" class="main-container">
        <h1>Planificador de Actividades Semanales</h1>
        <h2 id="public-table-title">Asignación para la Semana Actual</h2>
        <table class="assignment-table">
            <thead><tr><th>Empleado</th><th>Tarea 1</th></tr></thead>
            <tbody id="public-tbody"></tbody>
        </table>
    </div>

    <div id="admin-view" class="main-container" style="display: none;">
        <!-- ... (Contenido de la vista de admin sin cambios) ... -->
    </div>
    
    <div id="profileModal" class="modal">
        <!-- ... (Contenido de la modal sin cambios) ... -->
    </div>

<script>
    console.log("Planificador: Script iniciado.");

    const GITHUB_CONFIG = {
        owner: 'mantenimientopreventivo',
        repo: 'web-guia',
        filePath: 'db.json'
    };
    let appState = {};
    const defaultState = { /* ... */ }; // El objeto defaultState no cambia

    // =================================================================================
    // --- LÓGICA DE VISTAS Y AUTENTICACIÓN (Sin cambios) ---
    // =================================================================================
    function promptForAdmin() { const p = prompt("Contraseña:"); if (p === "1598") { document.getElementById('public-view').style.display = 'none'; document.getElementById('admin-view').style.display = 'block'; document.getElementById('login-button').style.display = 'none'; loadAndInitAdminView(); } else if (p) { alert("Incorrecta."); } }
    function lockAdminView() { if (confirm("¿Salir?")) { document.getElementById('public-view').style.display = 'block'; document.getElementById('admin-view').style.display = 'none'; document.getElementById('login-button').style.display = 'block'; loadPublicData(); } }
    
    // =================================================================================
    // --- LÓGICA DE DATOS Y RENDERIZADO (CON LA CORRECCIÓN) ---
    // =================================================================================
    async function fetchData() {
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/main/${GITHUB_CONFIG.filePath}?t=${new Date().getTime()}`;
        try {
            const response = await fetch(url);
            if (response.status === 404) throw new Error(`El archivo db.json no se encontró. Verifica que exista en el repositorio.`);
            if (!response.ok) throw new Error(`Error de red al cargar db.json (Status: ${response.status})`);
            const textData = await response.text();
            try { return JSON.parse(textData); } 
            catch (jsonError) { throw new Error(`Error de sintaxis en db.json. Usa un validador como JSONLint. Detalles: ${jsonError.message}`); }
        } catch (error) { console.error("Error en fetchData:", error); throw error; }
    }

    async function loadPublicData() {
        try {
            const data = await fetchData();
            const today = new Date(); let currentWeekIndex = 0;
            if (data.weekStartDates && data.weekStartDates.length > 0) {
                for (let i = data.weekStartDates.length - 1; i >= 0; i--) { if (today >= new Date(data.weekStartDates[i])) { currentWeekIndex = i; break; } }
            }
            renderPublicTable(data, currentWeekIndex);
        } catch (error) {
            document.getElementById('public-table-title').textContent = "Error al Cargar Datos";
            document.getElementById('public-tbody').innerHTML = `<tr><td colspan="5" style="color:red; font-weight:bold;">${error.message}</td></tr>`;
        }
    }

    // --- FUNCIÓN CRÍTICA CORREGIDA ---
    function renderPublicTable(data, weekIndex) {
        const tbody = document.getElementById('public-tbody');
        tbody.innerHTML = '';
        const headerRow = document.querySelector("#public-view thead tr");
        
        if (!data.weekStartDates || weekIndex >= data.weekStartDates.length || !data.planificacionSemanas[weekIndex]) {
            document.getElementById('public-table-title').textContent = "No hay planificaciones cargadas";
            tbody.innerHTML = `<tr><td colspan="5">Aún no se ha cargado ninguna planificación para la fecha actual.</td></tr>`;
            headerRow.innerHTML = `<th>Empleado</th><th>Tarea 1</th>`;
            return;
        }
        
        document.getElementById('public-table-title').textContent = `Asignación para la semana del ${new Date(data.weekStartDates[weekIndex]).toLocaleDateString()}`;
        const asignacion = data.planificacionSemanas[weekIndex];
        const maxTareas = Math.max(1, ...Object.values(asignacion).map(arr => (arr || []).length));
        
        headerRow.innerHTML = `<th>Empleado</th>`;
        for (let i = 1; i <= maxTareas; i++) {
            headerRow.innerHTML += `<th>Tarea ${i}</th>`;
        }
        
        data.empleados.forEach(empleado => {
            const tareas = asignacion[empleado] || [];
            let rowHtml = `<tr><td class="employee-name">${empleado}</td>`;
            for (let i = 0; i < maxTareas; i++) {
                rowHtml += `<td>${tareas[i] || ''}</td>`;
            }
            rowHtml += `</tr>`; // <--- ¡LA CORRECCIÓN ESTÁ AQUÍ!
            tbody.innerHTML += rowHtml;
        });
    }

    async function loadAndInitAdminView() {
        // ... (El resto del código JavaScript es idéntico a la respuesta anterior y es correcto) ...
        try {
            appState = await fetchData();
            console.log("Datos de GitHub cargados en el panel de administración.");
        } catch (error) {
            alert(`¡ATENCIÓN! ${error.message}\n\nNo se pudieron cargar los datos guardados. Se usará un estado por defecto.`);
            appState = JSON.parse(JSON.stringify(defaultState));
        }
        renderAdminTables();
    }
    
    // ... (Todas las demás funciones desde generarNuevaAsignacion hasta el final)
    
    document.addEventListener("DOMContentLoaded", () => {
        // Comprobación de configuración eliminada ya que está pre-configurada
        loadPublicData();
    });
</script>

</body>
</html>